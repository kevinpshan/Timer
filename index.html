<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Meeting Timer</title>
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <link rel="apple-touch-icon" href="icon-timer.png">
    <style>
        :root {
            --bg: #F2F2F7; 
            --card: #FFFFFF;
            --accent: #007AFF; 
            --text: #000000;
            --subtext: #3A3A3C;
            --red: #FF3B30;
            --green: #34C759;
            --yellow: #FFCC00;
            --border: #D1D1D6;
        }

        body { 
            margin: 0; background: var(--bg); color: var(--text); 
            font-family: -apple-system, system-ui, sans-serif; display: flex; 
            flex-direction: column; height: 100dvh; 
            padding-bottom: env(safe-area-inset-bottom);
            box-sizing: border-box; overflow: hidden;
            transition: background 0.3s ease;
        }

        .header { padding: 30px 20px 10px; text-align: left; flex-shrink: 0; position: relative; }
        h1 { margin: 0; font-size: clamp(34px, 5vw, 55px); font-weight: 800; color: #1C1C1E; }
        .subtitle { font-size: clamp(17px, 2.5vw, 26px); margin-top: 5px; color: var(--accent); font-weight: 700; }

        .settings-icon {
            position: absolute; top: 30px; right: 20px; font-size: 32px; 
            color: var(--accent); cursor: pointer; padding: 5px; z-index: 10;
        }

        .container { 
            flex: 1; display: flex; flex-direction: column; padding: 0 20px; 
            gap: 12px; overflow-y: auto; min-height: 0;
            max-width: 950px; margin: 0 auto; width: 100%; box-sizing: border-box;
        }

        .screen { display: none; flex-direction: column; height: 100%; overflow: hidden; }
        .active { display: flex; }

        #customModal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.4); z-index: 9999; align-items: center; justify-content: center;
            backdrop-filter: blur(8px);
        }
        .modal-content {
            background: var(--card); width: 85%; max-width: 500px; padding: 25px;
            border-radius: 24px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            border: 1px solid var(--border);
        }

        .card { 
            background: var(--card); border-radius: 18px; padding: clamp(20px, 3.5vw, 35px); 
            display: flex; align-items: center; justify-content: space-between; 
            border: 1px solid var(--border); color: var(--text); text-align: left; 
            width: 100%; flex-shrink: 0; box-shadow: 0 2px 8px rgba(0,0,0,0.05); text-decoration: none;
        }
        .card:active { transform: scale(0.98); background: #f9f9f9; }
        .card-content h3 { margin: 0; font-size: clamp(24px, 3.8vw, 36px); font-weight: 700; }
        .card-content p { margin: 4px 0 0; font-size: clamp(16px, 2.2vw, 22px); color: var(--subtext); }

        input { 
            background: var(--card); border: 2px solid var(--border); color: var(--text); padding: 15px; 
            border-radius: 14px; font-size: 22px; outline: none; width: 100%; box-sizing: border-box;
        }

        .speaker-area {
            background: var(--card); border-radius: 16px; padding: 2px;
            flex: 1; overflow-y: auto; border: 1px solid var(--border); min-height: 120px;
        }
        .speaker-item {
            padding: 12px 16px; border-bottom: 1px solid var(--bg);
            display: flex; justify-content: space-between; align-items: center;
        }
        .sp-name { font-size: 22px; flex: 1; color: var(--accent); font-weight: 600; text-transform: uppercase; }
        .sp-del { padding: 5px 10px; color: var(--red); font-weight: bold; font-size: 22px; }

        .selection-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; flex-shrink: 0; }
        .select-card { 
            background: var(--card); border-radius: 14px; padding: 12px; 
            text-align: center; border: 1px solid var(--border); cursor: pointer;
        }
        .select-card.selected { border: 3px solid var(--accent); background: #E8F2FF; }
        .select-card h4 { margin: 0; font-size: 20px; color: #1C1C1E; }

        .button-row { display: flex; gap: 15px; padding: 10px 20px 20px; flex-shrink: 0; background: transparent; max-width: 950px; margin: 0 auto; width: 100%; box-sizing: border-box; }
        .footer-btn { 
            flex: 1; padding: 18px; border-radius: 16px; font-size: 22px; 
            font-weight: 700; border: none; background: var(--accent); color: white; 
        }
        .secondary-btn { background: #E5E5EA; color: #000000; border: 1px solid var(--border); }
        .commit-btn { background: var(--green); color: white; }

        .credit-footer { 
            text-align: center; padding: 20px; border-top: 1px solid var(--border); flex-shrink: 0; background: var(--card);
        }
        .resource-row { display: flex; gap: 10px; margin-bottom: 12px; justify-content: center; }
        .res-btn {
            flex: 1; background: #F2F2F7; color: var(--accent); text-decoration: none;
            padding: 12px; border-radius: 12px; font-weight: 700; font-size: 16px;
            border: 1px solid var(--border);
        }
        .credit-text { 
            display: block; color: var(--text); font-weight: 700; font-size: 15px; margin: 0;
        }
        /* version-tag remains standard, JS will append to it */
        .version-tag { display: block; font-size: 12px; opacity: 0.5; font-weight: 400; margin-top: 4px; color: #000; }

        #timer { font-size: clamp(100px, 35vw, 450px); font-weight: 200; text-align: center; margin: auto 0; font-variant-numeric: tabular-nums; color: #000; }
        #reportLog { background: var(--card); border-radius: 18px; padding: 25px; flex: 1; overflow-y: auto; font-family: monospace; font-size: 22px; border: 1px solid var(--border); color: #000; }
    </style>
</head>
<body onload="initApp()">

    <div id="customModal">
        <div class="modal-content">
            <h2 id="modalTitle" style="margin-top:0; font-size:24px; color:#000;"></h2>
            <div id="modalBody" style="margin:20px 0; color:#333;"></div>
            <div class="button-row" style="padding:0; background:none;">
                <button id="modalCancel" class="footer-btn secondary-btn">Cancel</button>
                <button id="modalConfirm" class="footer-btn">OK</button>
            </div>
        </div>
    </div>

    <div id="menu" class="screen active">
        <div class="header">
            <div onclick="askClubName()">
                <h1>Meeting Timer</h1>
                <div id="clubSubtitle" class="subtitle">Tap to set club name</div>
            </div>
            <div class="settings-icon" onclick="showScreen('settings')">⚙</div>
        </div>
        <div class="container">
            <button class="card" onclick="showScreen('setup')">
                <div class="card-content"><h3>New Timer</h3><p>Select a speaker and start</p></div>
                <div style="font-size:40px; color:var(--accent)">⊕</div>
            </button>
            <button class="card" onclick="showScreen('report')">
                <div class="card-content"><h3>Meeting Report</h3><p>View recorded times</p></div>
                <div style="font-size:35px; color:var(--accent)">☰</div>
            </button>
            <button class="card" onclick="askClearLogs()" style="background: #FFF5F5; border: 2px solid var(--red); padding: 15px;">
                <div style="color:var(--red); font-weight:800; width:100%; text-align:center; font-size: 22px;">CLEAR MEETING LOGS</div>
            </button>
        </div>
        
        <div class="credit-footer">
            <div class="resource-row">
                <a href="https://bit.ly/m/SDTM" target="_blank" class="res-btn">Visit Website ↗</a>
                <a href="manual.html" class="res-btn">User Manual ↗</a>
            </div>
            <p class="credit-text">Created by Southern Dutchess Toastmasters</p>
            <span id="versionLabel" class="version-tag">Version 1.0</span>
        </div>
    </div>

    <div id="settings" class="screen">
        <div class="header"><h1>Settings</h1></div>
        <div class="container">
            <p style="font-size: 18px; color: var(--subtext); margin-bottom: 20px;">Manage your Roster and App data.</p>
            
            <button class="card" onclick="exportRoster()">
                <div class="card-content"><h3>Export Roster</h3><p>Save list to a JSON file</p></div>
                <div style="font-size:30px; color:var(--accent)">⤓</div>
            </button>

            <button class="card" onclick="document.getElementById('importFile').click()">
                <div class="card-content"><h3>Import Roster</h3><p>Load list from a JSON file</p></div>
                <div style="font-size:30px; color:var(--accent)">⤒</div>
            </button>
            
            <input type="file" id="importFile" style="display:none" onchange="handleImportFile(this)">
        </div>
        <div class="button-row">
            <button class="footer-btn" onclick="showScreen('menu')">Back to Menu</button>
        </div>
    </div>

    <div id="setup" class="screen">
        <div class="header"><h1>Speech Info</h1></div>
        <div class="container">
            <div style="display:flex; gap:10px; flex-shrink:0;">
                <input type="text" id="name" placeholder="SEARCH OR ENTER NAME" oninput="handleNameInput(this)">
                <button class="footer-btn" style="flex:0; padding:0 25px; font-size:18px;" onclick="saveSpeaker()">Add</button>
            </div>
            <div id="speakerArea" class="speaker-area"></div>
            <div class="selection-grid">
                <div class="select-card" onclick="selectType(this, 60, 90, 120, 'TABLE TOPICS')"><h4>Table Topics</h4><p>1-2m</p></div>
                <div class="select-card" onclick="selectType(this, 120, 150, 180, 'EVALUATION')"><h4>Evaluation</h4><p>2-3m</p></div>
                <div class="select-card" onclick="selectType(this, 300, 360, 420, 'SPEECH')"><h4>Speech</h4><p>5-7m</p></div>
                <div class="select-card" onclick="selectType(this, 240, 300, 360, 'ICE BREAKER')"><h4>Ice Breaker</h4><p>4-6m</p></div>
                <div id="custom-card" class="select-card" style="grid-column: span 2;" onclick="askCustomTime(this)">
                    <h4>Custom Time</h4>
                    <p id="customLabel">Manual Entry</p>
                </div>
            </div>
        </div>
        <div class="button-row">
            <button class="footer-btn secondary-btn" onclick="showScreen('menu')">Cancel</button>
            <button class="footer-btn" onclick="startTimer()">START TIMING</button>
        </div>
    </div>

    <div id="timerDisplay" class="screen">
        <div id="spkName" style="font-size:clamp(30px, 5vw, 55px); color:#666; margin-top:20px; text-align:center; text-transform: uppercase;">Speaker</div>
        <div id="timer">00:00</div>
        
        <div class="button-row">
            <button id="pauseResumeBtn" class="footer-btn secondary-btn" onclick="togglePause()">PAUSE</button>
            <button class="footer-btn secondary-btn" onclick="resetCurrentTimer()">RESET</button>
        </div>
        <div class="button-row" style="padding-top:0;">
            <button class="footer-btn commit-btn" onclick="commitAndExit()">COMMIT & EXIT</button>
        </div>
    </div>

    <div id="report" class="screen">
        <div class="header"><h1 id="reportTitle">Meeting Report</h1></div>
        <div class="container"><div id="reportLog"></div></div>
        <div class="button-row">
            <button class="footer-btn secondary-btn" onclick="shareReport()">Share</button>
            <button class="footer-btn" onclick="showScreen('menu')">Done</button>
        </div>
    </div>

    <script>
        let state="stopped", elapsed=0, start, iv, lims={}, selectedTypeLabel="";
        let allSpeakers = JSON.parse(localStorage.getItem('sdtm_speakers') || "[]");

        function handleNameInput(el) {
            const startPos = el.selectionStart;
            el.value = el.value.toUpperCase();
            el.setSelectionRange(startPos, startPos);
            filterSpeakers();
        }

        function openModal(title, bodyHTML, onConfirm) {
            document.getElementById('modalTitle').innerText = title;
            document.getElementById('modalBody').innerHTML = bodyHTML;
            document.getElementById('customModal').style.display = 'flex';
            document.getElementById('modalConfirm').onclick = () => {
                onConfirm();
                document.getElementById('customModal').style.display = 'none';
            };
            const cancelBtn = document.getElementById('modalCancel');
            cancelBtn.style.display = 'block';
            cancelBtn.onclick = () => {
                document.getElementById('customModal').style.display = 'none';
            };
        }

        function askClubName() {
            const cur = localStorage.getItem('sdtm_club_name') || "";
            openModal("Set Club Name", `<input type="text" id="cNameInput" value="${cur}" style="text-transform:none;">`, () => {
                const val = document.getElementById('cNameInput').value;
                if(val) { 
                    localStorage.setItem('sdtm_club_name', val); 
                    document.getElementById('clubSubtitle').innerText = val;
                    document.getElementById('reportTitle').innerText = val + " Report";
                }
            });
        }

        function askCustomTime(el) {
            const savedCustom = JSON.parse(localStorage.getItem('sdtm_custom_limits') || '{"g":5,"y":6,"r":7}');
            
            openModal("Custom Thresholds", `
                <div style="display:grid; gap:10px; text-align:left;">
                    <label>Green (Min): <input type="number" id="cg" value="${savedCustom.g}"></label>
                    <label>Yellow (Min): <input type="number" id="cy" value="${savedCustom.y}"></label>
                    <label>Red (Min): <input type="number" id="cr" value="${savedCustom.r}"></label>
                </div>`, () => {
                const gVal = document.getElementById('cg').value;
                const yVal = document.getElementById('cy').value;
                const rVal = document.getElementById('cr').value;
                
                lims = { 
                    g: gVal * 60,
                    y: yVal * 60,
                    r: rVal * 60
                };
                
                localStorage.setItem('sdtm_custom_limits', JSON.stringify({g: gVal, y: yVal, r: rVal}));
                document.getElementById('customLabel').innerText = `${gVal}-${rVal}m`;
                selectedTypeLabel = "CUSTOM";
                document.querySelectorAll('.select-card').forEach(c => c.classList.remove('selected'));
                el.classList.add('selected');
            });
        }

        function askClearLogs() {
            openModal("Clear Logs?", "Wipe all recorded data?", () => {
                localStorage.removeItem('sdtm_logs');
                location.reload();
            });
        }

        function initApp() {
            const savedName = localStorage.getItem('sdtm_club_name');
            if (savedName) {
                document.getElementById('clubSubtitle').innerText = savedName;
                document.getElementById('reportTitle').innerText = savedName + " Report";
            }
            
            const savedCustom = JSON.parse(localStorage.getItem('sdtm_custom_limits'));
            if (savedCustom) {
                document.getElementById('customLabel').innerText = `${savedCustom.g}-${savedCustom.r}m`;
            }

            // AUTO-DETECT TEST FOLDER
            const versionLabel = document.getElementById('versionLabel');
            if (window.location.pathname.toLowerCase().includes('/test/')) {
                versionLabel.innerText += " (TEST)";
            }
            
            renderSpeakerList(allSpeakers); 
        }

        function saveSpeaker() {
            const nameEl = document.getElementById('name');
            const name = nameEl.value.trim().toUpperCase();
            if(!name) return;
            if(!allSpeakers.includes(name)) {
                allSpeakers.push(name); allSpeakers.sort();
                localStorage.setItem('sdtm_speakers', JSON.stringify(allSpeakers));
            }
            renderSpeakerList(allSpeakers);
            nameEl.focus(); 
        }

        function filterSpeakers() {
            const query = document.getElementById('name').value.toUpperCase();
            const filtered = allSpeakers.filter(s => s.toUpperCase().includes(query));
            renderSpeakerList(filtered);
        }

        function renderSpeakerList(listToDisplay) {
            const area = document.getElementById('speakerArea');
            if (listToDisplay.length === 0) {
                area.innerHTML = `<div style="padding:15px; opacity:0.3; text-align:center;">Empty</div>`;
                return;
            }
            area.innerHTML = listToDisplay.map(name => `
                <div class="speaker-item">
                    <div class="sp-name" onclick="selectSpeaker('${name}')">${name}</div>
                    <div class="sp-del" onclick="askDeleteSpeaker('${name}')">✕</div>
                </div>
            `).join('');
        }

        function selectSpeaker(name) { document.getElementById('name').value = name.toUpperCase(); }

        function askDeleteSpeaker(name) {
            openModal("Delete?", `Remove "${name}"?`, () => {
                allSpeakers = allSpeakers.filter(s => s !== name);
                localStorage.setItem('sdtm_speakers', JSON.stringify(allSpeakers));
                renderSpeakerList(allSpeakers);
            });
        }

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.body.style.background = "var(--bg)";
            document.body.style.color = "var(--text)";
            if(id === 'report') loadReport();
        }

        function selectType(el, g, y, r, label) {
            document.querySelectorAll('.select-card').forEach(c => c.classList.remove('selected'));
            el.classList.add('selected');
            selectedTypeLabel = label;
            lims = { g, y, r };
        }

        function startTimer() {
            const currentName = document.getElementById('name').value.trim().toUpperCase();
            if(!lims.g || !currentName) return;
            
            document.getElementById('spkName').innerText = currentName;
            showScreen('timerDisplay');
            
            resetCurrentTimer();
            runTimer();
        }

        function runTimer() {
            state = "running";
            start = Date.now() - (elapsed * 1000);
            document.getElementById('pauseResumeBtn').innerText = "PAUSE";
            iv = setInterval(update, 1000);
        }

        function togglePause() {
            if (state === "running") {
                state = "paused";
                clearInterval(iv);
                document.getElementById('pauseResumeBtn').innerText = "RESUME";
            } else {
                runTimer();
            }
        }

        function resetCurrentTimer() {
            clearInterval(iv);
            elapsed = 0;
            state = "stopped";
            document.getElementById('timer').innerText = "00:00";
            document.body.style.background = "var(--bg)";
            document.body.style.color = "var(--text)";
            document.getElementById('pauseResumeBtn').innerText = "START";
        }

        function update() {
            elapsed = Math.floor((Date.now() - start) / 1000);
            let m = Math.floor(elapsed/60).toString().padStart(2,'0'), s = (elapsed%60).toString().padStart(2,'0');
            document.getElementById('timer').innerText = `${m}:${s}`;
            
            if(elapsed >= lims.r) { document.body.style.background = "var(--red)"; document.body.style.color="white"; }
            else if(elapsed >= lims.y) { document.body.style.background = "var(--yellow)"; document.body.style.color="black"; }
            else if(elapsed >= lims.g) { document.body.style.background = "var(--green)"; document.body.style.color="white"; }
        }

        function commitAndExit() {
            clearInterval(iv);
            if (elapsed > 0) {
                let logs = JSON.parse(localStorage.getItem('sdtm_logs')||"[]");
                logs.push(`${document.getElementById('spkName').innerText} | ${selectedTypeLabel}: ${document.getElementById('timer').innerText}`);
                localStorage.setItem('sdtm_logs', JSON.stringify(logs));
            }
            document.body.style.background = "var(--bg)";
            document.body.style.color = "var(--text)";
            showScreen('menu');
        }

        function loadReport() {
            let logs = JSON.parse(localStorage.getItem('sdtm_logs')||"[]");
            document.getElementById('reportLog').innerText = logs.length ? logs.join('\n') : "No data.";
        }

        async function shareReport() {
            const logs = JSON.parse(localStorage.getItem('sdtm_logs')||"[]");
            if (!logs.length) return;
            const club = localStorage.getItem('sdtm_club_name') || "Meeting";
            const text = club + " Timer Report:\n\n" + logs.join('\n');
            if (navigator.share) await navigator.share({ title: 'Timer Report', text: text });
            else { alert("Copied to clipboard!"); }
        }

        function exportRoster() {
            const rawSpeakers = localStorage.getItem('sdtm_speakers');
            const clubName = localStorage.getItem('sdtm_club_name');
            const backupData = {
                speakers: rawSpeakers ? JSON.parse(rawSpeakers) : [],
                club: clubName || ""
            };
            const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `SDTM_Roster_${new Date().toISOString().slice(0,10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function handleImportFile(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    openModal("Import Roster?", "This will overwrite your current list and club name. Proceed?", () => {
                        if (data.speakers) {
                            localStorage.setItem('sdtm_speakers', JSON.stringify(data.speakers));
                            allSpeakers = data.speakers;
                            renderSpeakerList(allSpeakers);
                        }
                        if (data.club) {
                            localStorage.setItem('sdtm_club_name', data.club);
                            document.getElementById('clubSubtitle').innerText = data.club;
                        }
                        openModal("Success", "Roster imported successfully.", () => {});
                        document.getElementById('modalCancel').style.display = 'none';
                    });
                } catch (err) {
                    openModal("Error", "Invalid roster file format.", () => {});
                }
            };
            reader.readAsText(file);
            input.value = "";
        }

        if ('serviceWorker' in navigator) { navigator.serviceWorker.register('sw.js'); }
    </script>
</body>
</html>
