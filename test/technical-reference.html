# Meeting Tools — Technical Reference
> Developer contract for `index.html` v2.10.3. Every item below must survive unchanged in any new version.

---

## LocalStorage Keys
Every key is prefixed dynamically based on URL path (`prod_` or `test_`) via:
```javascript
const prefix = window.location.pathname.toLowerCase().includes('/test/') ? 'test_' : 'prod_';
```

| Constant | Full Key (prod) | Stores |
|---|---|---|
| `KEY_LOGS` | `prod_sdtm_logs` | Array of session log strings |
| `KEY_CLUB` | `prod_sdtm_club_name` | Club name string |
| `KEY_SPEAKERS` | `prod_sdtm_speakers` | Array of speaker name strings |
| `KEY_FILLERS` | `prod_sdtm_fillers` | Array of filler word strings |
| `KEY_MD` | `prod_sdtm_md_toggle` | Boolean string for markdown export |
| `KEY_WOD_FULL` | `prod_sdtm_wod_full` | Object `{word, definition, example}` |
| `KEY_CUSTOM` | `prod_sdtm_custom_limits` | Object `{g, cy, r}` in minutes |
| `KEY_AI_KEY` | `prod_sdtm_openai_key` | OpenAI API key string |
| `KEY_TRANSCRIPTS` | `prod_sdtm_transcripts` | Array of transcript objects `{speaker, role, date, highlightedHTML, fillerSummary, plainText}` |

---

## Global State Variables

| Variable | Type | Purpose |
|---|---|---|
| `currentMode` | string | `'timer'` or `'counter'` |
| `currentSpeaker` | string | Active speaker's name |
| `currentTally` | object | `{fillerWord: count}` for current session |
| `iv` | interval | Timer interval handle |
| `start` | number | Timestamp when timer started |
| `elapsed` | number | Seconds elapsed |
| `lims` | object | `{g, y, r}` thresholds in seconds |
| `selectedTypeLabel` | string | Selected role label (e.g. "SPEECH") |
| `fillerList` | array | Current list of filler words |
| `allSpeakers` | array | Roster of all speakers |
| `activeWodData` | object | `{word, definition, example}` from current WOD session |
| `WOD_LIBRARY` | array | ~1000 words hardcoded |
| `recordingEnabled` | boolean | Whether "Record Speech" toggle is on |
| `recordingStream` | MediaStream | Active microphone stream (null when idle) |
| `transcriptResult` | string | Plain text from last Whisper transcription |
| `transcriptCounts` | object | `{fillerWord: count}` auto-detected from transcript |
| `activeTranscriptIndex` | number | Index of transcript currently open in transcript viewer |

---

## Screens

All screens use the `showScreen(id)` pattern — hides all `.screen` divs, shows the target.

| Screen ID | Purpose |
|---|---|
| `menu` | Main hub, has timer/counter tab toggle |
| `wod` | Word of the Day — search/generate/select |
| `setup` | Speaker name input + roster + record toggle + role grid |
| `counterDisplay` | Live tally grid during counter session |
| `timerDisplay` | Live countdown/countup timer |
| `report` | Displays formatted log of all sessions |
| `settings` | API key, markdown toggle, backup/restore, clear |
| `transcriptionDisplay` | Shows live Whisper transcript with highlights; merge button sends to counter |
| `transcriptList` | List of all saved transcripts for the current meeting |
| `transcriptView` | Shows a single saved transcript with filler summary and Share button |

---

## Every Function

| Function | What it does |
|---|---|
| `initApp()` | Runs on body load — loads club name, toggle state, API key, version label, refreshes roster, loads first WOD |
| `nextWod()` | Picks random word from library, calls `fetchWordDetails()` |
| `searchWod()` | Reads manual input field, calls `fetchWordDetails()` |
| `fetchWordDetails(word)` | Calls OpenAI GPT-4o-mini, renders definition + example in WOD card |
| `selectWod()` | Pins active WOD to fillerList and localStorage |
| `saveSettings()` | Writes markdown toggle + API key to localStorage |
| `refreshRoster()` | Renders full speaker list in `speakerArea` |
| `saveSpeaker()` | Adds new name to roster, sorts, saves |
| `selectSpeaker(n)` | Fills name input when a roster name is tapped |
| `handleNameInput(el)` | Filters roster live as user types, uppercases input |
| `renderSpeakerListFiltered(f)` | Renders a filtered subset of the roster |
| `askDeleteSpeaker(n)` | Opens modal to confirm speaker deletion |
| `showScreen(id)` | Hides all screens, shows target; triggers `renderSetupGrid()`, `loadReport()`, or `loadTranscriptList()` as needed |
| `renderSetupGrid()` | Builds role card grid — timer presets or counter roles depending on `currentMode` |
| `selectRole(el, g, y, r, label)` | Sets `lims`, `selectedTypeLabel`, highlights selected card |
| `askCustomTime(el)` | Opens modal with inputs for custom thresholds (timer) or custom role name (counter) |
| `switchMode(m)` | Switches between timer and counter tabs |
| `handleStart()` | Validates name + role; if `recordingEnabled` routes to `transcriptionDisplay`, else to `timerDisplay` or `counterDisplay` |
| `startRecording()` | Requests mic, starts MediaRecorder, updates UI |
| `stopRecording()` | Stops MediaRecorder, triggers Whisper transcription |
| `sendToWhisper()` | POSTs audio blob to OpenAI Whisper API, calls `analyzeTranscript()` |
| `analyzeTranscript(text)` | Detects fillers in transcript, builds highlighted HTML, stores counts |
| `mergeTranscriptToCounter()` | Stops stream, merges transcript counts into tally, saves transcript to `KEY_TRANSCRIPTS`, navigates to counterDisplay |
| `initTally()` | Resets `currentTally` to zero for all fillers, calls `renderTally()` |
| `renderTally()` | Builds tally grid cards, sorts WOD to top |
| `incTally(f)` | Increments a filler count |
| `decTally(e, f)` | Decrements a filler count (min 0) |
| `delFiller(e, f)` | Removes a filler from `fillerList` via modal confirm |
| `saveCounterSession()` | Saves/merges tally to `KEY_LOGS`, shows confirmation modal |
| `parseTallyString(s)` | Deserializes a tally log string back to object |
| `serializeTally(o)` | Serializes tally object to log string |
| `startTimer()` | Starts interval, updates display, changes `body` background on thresholds |
| `togglePause()` | Pauses/resumes the timer interval |
| `commitAndExit()` | Saves timer result to logs, resets background, returns to menu |
| `loadReport()` | Builds formatted report string from logs + WOD, renders to `reportLog` |
| `generateReportText()` | Returns plain or markdown report string (used by copy + share) |
| `copyReport()` | Copies report to clipboard via modal confirm |
| `shareReport()` | Uses Web Share API |
| `exportData()` | Downloads JSON backup of speakers, fillers, club name, API key (transcripts excluded) |
| `handleImportFile(i)` | Reads uploaded JSON, restores all data, reloads page |
| `askClubName()` | Modal to set club name |
| `askClearLogs()` | Modal to confirm full reset of logs, WOD, and transcripts |
| `openModal(t, b, c)` | Core modal function — sets title, body HTML, confirm callback |
| `loadTranscriptList()` | Renders list of saved transcripts in `transcriptListArea` |
| `openTranscript(i)` | Loads a single transcript into the viewer screen |
| `shareTranscript()` | Shares transcript via Web Share API; format depends on markdown toggle — full markdown if on, plain text with `**fillers**` if off |

---

## Default Filler List
`["AH", "UH", "UM", "ER", "SO", "LIKE", "YOU KNOW", "WORD OF DAY"]`

"WORD OF DAY" is a placeholder replaced by the active WOD word when one is selected.

---

## CSS — Key Classes to Preserve

| Class/ID | Purpose |
|---|---|
| `.screen` / `.screen.active` | Show/hide screen system |
| `.tab` / `.tab.active` | Mode switcher tabs |
| `.main-menu-card` | Menu item cards |
| `.role-card` / `.role-card.selected` | Setup grid cards |
| `.tally-card` / `.tally-card.wod-active` | Counter grid cards |
| `.tally-del` / `.tally-minus` | Delete/decrement buttons on tally cards |
| `.wod-card-big`, `.wod-word`, `.wod-def`, `.wod-example` | WOD display layout |
| `.footer-btn` / `.secondary-btn` | All action buttons |
| `.button-row` | Button container at screen bottom |
| `.credit-footer` | Bottom branding area on menu |
| `#customModal` | Modal overlay |
| `.highlight-filler` | Red highlight on filler words in transcript |
| `.highlight-wod` | Gold highlight on Word of the Day in transcript |
| `body` background | Changes to `--green`, `--yellow`, `--red` during timing — must be `var(--bg)` at rest |

---

## CSS Variables (`:root`)

| Variable | Value | Usage |
|---|---|---|
| `--bg` | `#F2F2F7` | Page background |
| `--card` | `#FFFFFF` | Card/surface background |
| `--accent` | `#007AFF` | Primary blue (buttons, names, tabs) |
| `--text` | `#000000` | Primary text |
| `--subtext` | `#3A3A3C` | Secondary text |
| `--red` | `#FF3B30` | Timer max / delete actions |
| `--green` | `#34C759` | Timer min / save actions |
| `--yellow` | `#FFCC00` | Timer target |
| `--gold` | `#BF941A` | WOD accent color |
| `--border` | `#D1D1D6` | Card and input borders |

---

## Transcript Data Architecture
- Transcripts are saved on `mergeTranscriptToCounter()` to `KEY_TRANSCRIPTS` as a JSON array
- Each entry: `{ speaker, role, date, highlightedHTML, fillerSummary, plainText }`
- `highlightedHTML` — rendered HTML with `.highlight-filler` and `.highlight-wod` spans (for display)
- `plainText` — raw Whisper transcript string (for sharing)
- Transcripts are **excluded from backup export** (meeting-specific, session-only data)
- Transcripts are **cleared with "Clear Meeting Data"** along with logs and WOD

## Share Behavior (Transcript)
- **Markdown ON:** Shares full markdown — `# Header`, `**role**`, `> filler summary`, `---`, fillers as `**BOLD CAPS**`
- **Markdown OFF:** Shares plain text with `**filler**` markers only — compatible with email, Notes, Messages

---

## Deployment Notes
- The `prefix` variable auto-detects `/test/` in the URL path and uses `test_` for all localStorage keys, otherwise `prod_`
- Copying the file from `/test/index.html` to `/index.html` requires **zero changes** — the prefix shifts automatically
- Test and production data are fully isolated in localStorage on the same device
- Version label is rendered dynamically by `initApp()` into `#versionLabel`

---

## Rules for Safe Feature Addition
1. Every function name above must remain identical
2. Every localStorage key constant name must remain identical
3. Every screen ID must remain identical
4. No existing CSS class may be renamed or removed
5. New screens are added as new `<div id="newscreen" class="screen">` blocks — `showScreen()` handles them automatically
6. New localStorage keys get new constant names with the same `prefix +` pattern
7. New global variables must not shadow any existing variable name
8. The `body` background must always return to `var(--bg)` when leaving the timer screen
9. `openModal(t, b, c)` is the only modal system — no `alert()` or `confirm()` calls
10. Transcripts are never included in backup export JSON