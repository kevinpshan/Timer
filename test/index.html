<script>
    // --- DYNAMIC STORAGE KEY LOGIC ---
    // This prefix ensures 'test' and 'root' don't overwrite each other
    const isTestEnv = window.location.pathname.toLowerCase().includes('/test/');
    const prefix = isTestEnv ? 'test_' : 'prod_';

    const KEY_SPEAKERS = prefix + 'sdtm_speakers';
    const KEY_LOGS = prefix + 'sdtm_logs';
    const KEY_CLUB = prefix + 'sdtm_club_name';
    const KEY_CUSTOM = prefix + 'sdtm_custom_limits';

    // Update initial load to use these dynamic keys
    let state="stopped", elapsed=0, start, iv, lims={}, selectedTypeLabel="";
    let allSpeakers = JSON.parse(localStorage.getItem(KEY_SPEAKERS) || "[]");

    function handleNameInput(el) {
        const startPos = el.selectionStart;
        el.value = el.value.toUpperCase();
        el.setSelectionRange(startPos, startPos);
        filterSpeakers();
    }

    function openModal(title, bodyHTML, onConfirm) {
        document.getElementById('modalTitle').innerText = title;
        document.getElementById('modalBody').innerHTML = bodyHTML;
        document.getElementById('customModal').style.display = 'flex';
        document.getElementById('modalConfirm').onclick = () => {
            onConfirm();
            document.getElementById('customModal').style.display = 'none';
        };
        const cancelBtn = document.getElementById('modalCancel');
        cancelBtn.style.display = 'block';
        cancelBtn.onclick = () => {
            document.getElementById('customModal').style.display = 'none';
        };
    }

    function askClubName() {
        const cur = localStorage.getItem(KEY_CLUB) || "";
        openModal("Set Club Name", `<input type="text" id="cNameInput" value="${cur}" style="text-transform:none;">`, () => {
            const val = document.getElementById('cNameInput').value;
            if(val) { 
                localStorage.setItem(KEY_CLUB, val); 
                document.getElementById('clubSubtitle').innerText = val;
                document.getElementById('reportTitle').innerText = val + " Report";
            }
        });
    }

    function askCustomTime(el) {
        const savedCustom = JSON.parse(localStorage.getItem(KEY_CUSTOM) || '{"g":5,"y":6,"r":7}');
        openModal("Custom Thresholds", `
            <div style="display:grid; gap:10px; text-align:left;">
                <label>Green (Min): <input type="number" id="cg" value="${savedCustom.g}"></label>
                <label>Yellow (Min): <input type="number" id="cy" value="${savedCustom.y}"></label>
                <label>Red (Min): <input type="number" id="cr" value="${savedCustom.r}"></label>
            </div>`, () => {
            const gVal = document.getElementById('cg').value;
            const yVal = document.getElementById('cy').value;
            const rVal = document.getElementById('cr').value;
            lims = { g: gVal * 60, y: yVal * 60, r: rVal * 60 };
            localStorage.setItem(KEY_CUSTOM, JSON.stringify({g: gVal, y: yVal, r: rVal}));
            document.getElementById('customLabel').innerText = `${gVal}-${rVal}m`;
            selectedTypeLabel = "CUSTOM";
            document.querySelectorAll('.select-card').forEach(c => c.classList.remove('selected'));
            el.classList.add('selected');
        });
    }

    function askClearLogs() {
        openModal("Clear Logs?", "Wipe all recorded data?", () => {
            localStorage.removeItem(KEY_LOGS);
            location.reload();
        });
    }

    function initApp() {
        const savedName = localStorage.getItem(KEY_CLUB);
        if (savedName) {
            document.getElementById('clubSubtitle').innerText = savedName;
            document.getElementById('reportTitle').innerText = savedName + " Report";
        }
        const savedCustom = JSON.parse(localStorage.getItem(KEY_CUSTOM));
        if (savedCustom) {
            document.getElementById('customLabel').innerText = `${savedCustom.g}-${savedCustom.r}m`;
        }
        const versionLabel = document.getElementById('versionLabel');
        if (isTestEnv) {
            versionLabel.innerText += " (TEST)";
        }
        renderSpeakerList(allSpeakers); 
    }

    function saveSpeaker() {
        const nameEl = document.getElementById('name');
        const name = nameEl.value.trim().toUpperCase();
        if(!name) return;
        if(!allSpeakers.includes(name)) {
            allSpeakers.push(name); allSpeakers.sort();
            localStorage.setItem(KEY_SPEAKERS, JSON.stringify(allSpeakers));
        }
        renderSpeakerList(allSpeakers);
        nameEl.focus(); 
    }

    function filterSpeakers() {
        const query = document.getElementById('name').value.toUpperCase();
        const filtered = allSpeakers.filter(s => s.toUpperCase().includes(query));
        renderSpeakerList(filtered);
    }

    function renderSpeakerList(listToDisplay) {
        const area = document.getElementById('speakerArea');
        if (listToDisplay.length === 0) {
            area.innerHTML = `<div style="padding:15px; opacity:0.3; text-align:center;">Empty</div>`;
            return;
        }
        area.innerHTML = listToDisplay.map(name => `
            <div class="speaker-item">
                <div class="sp-name" onclick="selectSpeaker('${name}')">${name}</div>
                <div class="sp-del" onclick="askDeleteSpeaker('${name}')">âœ•</div>
            </div>
        `).join('');
    }

    function selectSpeaker(name) { document.getElementById('name').value = name.toUpperCase(); }

    function askDeleteSpeaker(name) {
        openModal("Delete?", `Remove "${name}"?`, () => {
            allSpeakers = allSpeakers.filter(s => s !== name);
            localStorage.setItem(KEY_SPEAKERS, JSON.stringify(allSpeakers));
            renderSpeakerList(allSpeakers);
        });
    }

    function showScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.body.style.background = "var(--bg)";
        document.body.style.color = "var(--text)";
        if(id === 'report') loadReport();
    }

    function selectType(el, g, y, r, label) {
        document.querySelectorAll('.select-card').forEach(c => c.classList.remove('selected'));
        el.classList.add('selected');
        selectedTypeLabel = label;
        lims = { g, y, r };
    }

    function startTimer() {
        const currentName = document.getElementById('name').value.trim().toUpperCase();
        if(!lims.g || !currentName) return;
        document.getElementById('spkName').innerText = currentName;
        showScreen('timerDisplay');
        resetCurrentTimer();
        runTimer();
    }

    function runTimer() {
        state = "running";
        start = Date.now() - (elapsed * 1000);
        document.getElementById('pauseResumeBtn').innerText = "PAUSE";
        iv = setInterval(update, 1000);
    }

    function togglePause() {
        if (state === "running") {
            state = "paused";
            clearInterval(iv);
            document.getElementById('pauseResumeBtn').innerText = "RESUME";
        } else {
            runTimer();
        }
    }

    function resetCurrentTimer() {
        clearInterval(iv);
        elapsed = 0;
        state = "stopped";
        document.getElementById('timer').innerText = "00:00";
        document.body.style.background = "var(--bg)";
        document.body.style.color = "var(--text)";
        document.getElementById('pauseResumeBtn').innerText = "START";
    }

    function update() {
        elapsed = Math.floor((Date.now() - start) / 1000);
        let m = Math.floor(elapsed/60).toString().padStart(2,'0'), s = (elapsed%60).toString().padStart(2,'0');
        document.getElementById('timer').innerText = `${m}:${s}`;
        if(elapsed >= lims.r) { document.body.style.background = "var(--red)"; document.body.style.color="white"; }
        else if(elapsed >= lims.y) { document.body.style.background = "var(--yellow)"; document.body.style.color="black"; }
        else if(elapsed >= lims.g) { document.body.style.background = "var(--green)"; document.body.style.color="white"; }
    }

    function commitAndExit() {
        clearInterval(iv);
        if (elapsed > 0) {
            let logs = JSON.parse(localStorage.getItem(KEY_LOGS)||"[]");
            logs.push(`${document.getElementById('spkName').innerText} | ${selectedTypeLabel}: ${document.getElementById('timer').innerText}`);
            localStorage.setItem(KEY_LOGS, JSON.stringify(logs));
        }
        document.body.style.background = "var(--bg)";
        document.body.style.color = "var(--text)";
        showScreen('menu');
    }

    function loadReport() {
        let logs = JSON.parse(localStorage.getItem(KEY_LOGS)||"[]");
        document.getElementById('reportLog').innerText = logs.length ? logs.join('\n') : "No data.";
    }

    async function shareReport() {
        const logs = JSON.parse(localStorage.getItem(KEY_LOGS)||"[]");
        if (!logs.length) return;
        const club = localStorage.getItem(KEY_CLUB) || "Meeting";
        const text = club + " Timer Report:\n\n" + logs.join('\n');
        if (navigator.share) await navigator.share({ title: 'Timer Report', text: text });
        else { alert("Copied to clipboard!"); }
    }

    function exportRoster() {
        const rawSpeakers = localStorage.getItem(KEY_SPEAKERS);
        const clubName = localStorage.getItem(KEY_CLUB);
        const backupData = { speakers: rawSpeakers ? JSON.parse(rawSpeakers) : [], club: clubName || "" };
        const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `SDTM_Roster_${new Date().toISOString().slice(0,10)}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    function handleImportFile(input) {
        const file = input.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = JSON.parse(e.target.result);
                openModal("Import Roster?", "This will overwrite your current list and club name. Proceed?", () => {
                    if (data.speakers) {
                        localStorage.setItem(KEY_SPEAKERS, JSON.stringify(data.speakers));
                        allSpeakers = data.speakers;
                        renderSpeakerList(allSpeakers);
                    }
                    if (data.club) {
                        localStorage.setItem(KEY_CLUB, data.club);
                        document.getElementById('clubSubtitle').innerText = data.club;
                    }
                    openModal("Success", "Roster imported successfully.", () => {});
                    document.getElementById('modalCancel').style.display = 'none';
                });
            } catch (err) {
                openModal("Error", "Invalid roster file format.", () => {});
            }
        };
        reader.readAsText(file);
        input.value = "";
    }

    if ('serviceWorker' in navigator) { navigator.serviceWorker.register('sw.js'); }
</script>
