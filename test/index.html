<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Meeting Tools</title>
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <link rel="apple-touch-icon" href="icon-timer.png">
    <style>
        :root {
            --bg: #F2F2F7; 
            --card: #FFFFFF;
            --accent: #007AFF; 
            --text: #000000;
            --subtext: #3A3A3C;
            --red: #FF3B30;
            --green: #34C759;
            --yellow: #FFCC00;
            --border: #D1D1D6;
        }

        body { 
            margin: 0; background: var(--bg); color: var(--text); 
            font-family: -apple-system, system-ui, sans-serif; display: flex; 
            flex-direction: column; height: 100dvh; 
            box-sizing: border-box; overflow: hidden;
            transition: background 0.3s ease;
        }

        /* TABS AT THE TOP (ABOVE HEADER) */
        .top-nav {
            background: #E3E3E8; padding: 10px 20px 5px; flex-shrink: 0;
            display: flex; gap: 8px; padding-top: calc(env(safe-area-inset-top) + 10px);
        }
        .nav-tab {
            flex: 1; padding: 10px; text-align: center; font-weight: 600; font-size: 14px;
            border-radius: 10px 10px 0 0; cursor: pointer; color: var(--subtext);
            transition: all 0.2s;
        }
        .nav-tab.active { background: var(--bg); color: var(--accent); position: relative; }
        .nav-tab.active::after {
            content: ""; position: absolute; bottom: -5px; left: 0; width: 100%; height: 5px; background: var(--bg);
        }

        .header { padding: 15px 20px 10px; text-align: left; flex-shrink: 0; position: relative; }
        h1 { margin: 0; font-size: clamp(30px, 4vw, 45px); font-weight: 800; color: #1C1C1E; }
        .subtitle { font-size: 16px; margin-top: 2px; color: var(--accent); font-weight: 700; text-transform: uppercase; }

        .settings-icon {
            position: absolute; top: 20px; right: 20px; font-size: 28px; 
            color: var(--accent); cursor: pointer; padding: 5px; z-index: 10;
        }

        .container { 
            flex: 1; display: flex; flex-direction: column; padding: 0 20px; 
            gap: 12px; overflow-y: auto; min-height: 0;
            max-width: 950px; margin: 0 auto; width: 100%; box-sizing: border-box;
        }

        .screen { display: none; flex-direction: column; height: 100%; overflow: hidden; }
        .screen.active { display: flex; }

        .card { 
            background: var(--card); border-radius: 18px; padding: clamp(20px, 3.5vw, 30px); 
            display: flex; align-items: center; justify-content: space-between; 
            border: 1px solid var(--border); color: var(--text); text-align: left; 
            width: 100%; flex-shrink: 0; box-shadow: 0 2px 8px rgba(0,0,0,0.05); text-decoration: none;
            cursor: pointer;
        }
        .card:active { transform: scale(0.98); background: #f9f9f9; }
        .card-content h3 { margin: 0; font-size: clamp(22px, 3vw, 32px); font-weight: 700; }
        .card-content p { margin: 4px 0 0; font-size: 16px; color: var(--subtext); }

        #customModal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.4); z-index: 9999; align-items: center; justify-content: center;
            backdrop-filter: blur(8px);
        }
        .modal-content {
            background: var(--card); width: 85%; max-width: 500px; padding: 25px;
            border-radius: 24px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            border: 1px solid var(--border);
        }

        input { 
            background: var(--card); border: 2px solid var(--border); color: var(--text); padding: 15px; 
            border-radius: 14px; font-size: 22px; outline: none; width: 100%; box-sizing: border-box;
        }

        .speaker-area {
            background: var(--card); border-radius: 16px; padding: 2px;
            flex: 1; overflow-y: auto; border: 1px solid var(--border); min-height: 120px;
        }
        .speaker-item {
            padding: 12px 16px; border-bottom: 1px solid var(--bg);
            display: flex; justify-content: space-between; align-items: center;
        }
        .sp-name { font-size: 20px; flex: 1; color: var(--accent); font-weight: 600; text-transform: uppercase; }
        .sp-del { padding: 5px 10px; color: var(--red); font-weight: bold; font-size: 20px; }

        .button-row { display: flex; gap: 15px; padding: 10px 20px 20px; flex-shrink: 0; background: transparent; max-width: 950px; margin: 0 auto; width: 100%; box-sizing: border-box; }
        .footer-btn { 
            flex: 1; padding: 18px; border-radius: 16px; font-size: 22px; 
            font-weight: 700; border: none; background: var(--accent); color: white; 
        }
        .secondary-btn { background: #E5E5EA; color: #000000; border: 1px solid var(--border); }
        
        .credit-footer { text-align: center; padding: 20px; border-top: 1px solid var(--border); flex-shrink: 0; background: var(--card); }
        .version-tag { display: block; font-size: 12px; opacity: 0.5; font-weight: 400; margin-top: 4px; color: #000; }

        #timer { font-size: clamp(100px, 35vw, 400px); font-weight: 200; text-align: center; margin: auto 0; font-variant-numeric: tabular-nums; }
        
        /* TALLY BUTTONS */
        .tally-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; flex: 1; }
        .tally-btn {
            background: white; border: 1px solid var(--border); border-radius: 20px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .tally-btn:active { background: #F2F2F7; transform: scale(0.95); }
        .tally-count { font-size: 40px; font-weight: 800; color: var(--accent); }
        .tally-label { font-size: 18px; font-weight: 600; color: var(--subtext); }
    </style>
</head>
<body onload="initApp()">

    <div class="top-nav">
        <div id="tabTimer" class="nav-tab active" onclick="switchMode('timer')">TIMER</div>
        <div id="tabCounter" class="nav-tab" onclick="switchMode('counter')">AH-COUNTER</div>
    </div>

    <div id="menu" class="screen active">
        <div class="header">
            <h1 id="modeTitle">Meeting Timer</h1>
            <div id="clubSubtitle" class="subtitle" onclick="askClubName()">SET CLUB NAME</div>
            <div class="settings-icon" onclick="showScreen('settings')">‚öô</div>
        </div>

        <div id="timerMode" class="container">
            <button class="card" onclick="showScreen('setup')">
                <div class="card-content"><h3>New Timer</h3><p>Select a speaker and start</p></div>
                <div style="font-size:35px; color:var(--accent)">‚äï</div>
            </button>
            <button class="card" onclick="showScreen('report')">
                <div class="card-content"><h3>Meeting Report</h3><p>View recorded times</p></div>
                <div style="font-size:35px; color:var(--accent)">‚ò∞</div>
            </button>
        </div>

        <div id="counterMode" class="container" style="display:none;">
            <button class="card" onclick="showScreen('setup')">
                <div class="card-content"><h3>Start Tracking</h3><p>Count filler words per speaker</p></div>
                <div style="font-size:35px; color:var(--accent)">‚úç</div>
            </button>
            <button class="card" onclick="openModal('Coming Soon', 'Ah-Counter reports are in development.', ()=>{})">
                <div class="card-content"><h3>Counter Report</h3><p>View filler word totals</p></div>
                <div style="font-size:35px; color:var(--accent)">üìä</div>
            </button>
        </div>

        <div class="container" style="flex:0; margin-top: 10px;">
            <button class="card" onclick="askClearLogs()" style="background: #FFF5F5; border: 2px solid var(--red); padding: 12px;">
                <div style="color:var(--red); font-weight:800; width:100%; text-align:center; font-size: 18px;">RESET ALL DATA</div>
            </button>
        </div>
        
        <div class="credit-footer">
            <p style="font-weight:700; font-size:14px; margin:0;">Southern Dutchess Toastmasters</p>
            <span id="versionLabel" class="version-tag">Version 1.0</span>
        </div>
    </div>

    <div id="settings" class="screen">
        <div class="header"><h1>Settings</h1></div>
        <div class="container">
            <h3>Roster Management</h3>
            <button class="card" onclick="exportRoster()">
                <div class="card-content"><h3>Backup Roster</h3><p>Export to JSON file</p></div>
                <div style="font-size:24px; color:var(--accent)">‚§ì</div>
            </button>
            <button class="card" onclick="document.getElementById('importFile').click()">
                <div class="card-content"><h3>Restore Roster</h3><p>Import from JSON file</p></div>
                <div style="font-size:24px; color:var(--accent)">‚§í</div>
            </button>
            <input type="file" id="importFile" style="display:none" onchange="handleImportFile(this)">
        </div>
        <div class="button-row">
            <button class="footer-btn" onclick="showScreen('menu')">Back to Menu</button>
        </div>
    </div>

    <div id="setup" class="screen">
        <div class="header"><h1 id="setupTitle">Select Speaker</h1></div>
        <div class="container">
            <div style="display:flex; gap:10px; flex-shrink:0;">
                <input type="text" id="name" placeholder="ENTER NAME" oninput="handleNameInput(this)">
                <button class="footer-btn" style="flex:0; padding:0 25px; font-size:18px;" onclick="saveSpeaker()">Add</button>
            </div>
            <div id="speakerArea" class="speaker-area"></div>
            
            <div id="timerPresets" class="selection-grid">
                <div class="select-card" onclick="selectType(this, 60, 90, 120, 'TABLE TOPICS')"><h4>Table Topics</h4><p>1-2m</p></div>
                <div class="select-card" onclick="selectType(this, 120, 150, 180, 'EVALUATION')"><h4>Evaluation</h4><p>2-3m</p></div>
                <div class="select-card" onclick="selectType(this, 300, 360, 420, 'SPEECH')"><h4>Speech</h4><p>5-7m</p></div>
                <div id="custom-card" class="select-card" onclick="askCustomTime(this)"><h4>Custom</h4><p id="customLabel">Manual</p></div>
            </div>
        </div>
        <div class="button-row">
            <button class="footer-btn secondary-btn" onclick="showScreen('menu')">Cancel</button>
            <button id="startBtn" class="footer-btn" onclick="handleStart()">START</button>
        </div>
    </div>

    <div id="timerDisplay" class="screen">
        <div id="spkName" style="font-size:30px; color:#666; margin-top:20px; text-align:center; text-transform: uppercase; font-weight:700;">Speaker</div>
        <div id="timer">00:00</div>
        <div class="button-row">
            <button id="pauseResumeBtn" class="footer-btn secondary-btn" onclick="togglePause()">PAUSE</button>
            <button class="footer-btn commit-btn" onclick="commitAndExit()">COMMIT & EXIT</button>
        </div>
    </div>

    <div id="report" class="screen">
        <div class="header"><h1>Meeting Report</h1></div>
        <div class="container"><div id="reportLog"></div></div>
        <div class="button-row">
            <button class="footer-btn secondary-btn" onclick="shareReport()">Share</button>
            <button class="footer-btn" onclick="showScreen('menu')">Done</button>
        </div>
    </div>

    <script>
        // ... (Persistence and Logic stays the same, adding mode handling) ...
        let currentMode = 'timer'; // 'timer' or 'counter'

        function switchMode(mode) {
            currentMode = mode;
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.getElementById(mode === 'timer' ? 'tabTimer' : 'tabCounter').classList.add('active');
            
            document.getElementById('modeTitle').innerText = mode === 'timer' ? 'Meeting Timer' : 'Ah-Counter';
            document.getElementById('timerMode').style.display = mode === 'timer' ? 'flex' : 'none';
            document.getElementById('counterMode').style.display = mode === 'counter' ? 'flex' : 'none';
        }

        function handleStart() {
            if (currentMode === 'timer') startTimer();
            else openModal('Coming Soon', 'The Ah-Counter tally screen is next!', ()=>{});
        }

        // ... (Keep your initApp, export, import, and timer logic here) ...
        // Note: In showScreen('setup'), add logic to hide/show 'timerPresets' based on currentMode
        
        const isTestEnv = window.location.pathname.toLowerCase().includes('/test/');
        const prefix = isTestEnv ? 'test_' : 'prod_';
        const KEY_SPEAKERS = prefix + 'sdtm_speakers';
        const KEY_CLUB = prefix + 'sdtm_club_name';
        
        let allSpeakers = JSON.parse(localStorage.getItem(KEY_SPEAKERS) || "[]");

        function initApp() {
            const savedName = localStorage.getItem(KEY_CLUB);
            if (savedName) document.getElementById('clubSubtitle').innerText = savedName;
            renderSpeakerList(allSpeakers);
            const versionLabel = document.getElementById('versionLabel');
            if (isTestEnv) versionLabel.innerText += " (TEST)";
        }

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            if (id === 'setup') {
                document.getElementById('timerPresets').style.display = currentMode === 'timer' ? 'grid' : 'none';
                document.getElementById('setupTitle').innerText = currentMode === 'timer' ? 'Speech Info' : 'Ah-Counter Setup';
            }
        }

        // (Include all your previous helper functions: saveSpeaker, renderSpeakerList, etc.)
        // This is a structural skeleton - I will provide the full code in the next response if you like this layout!
    </script>
</body>
</html>
