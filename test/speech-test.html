<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pro Grammarian Lab (Whisper)</title>
    <style>
        body { font-family: -apple-system, sans-serif; background: #F2F2F7; padding: 20px; color: #1C1C1E; }
        .transcript-box { background: white; border-radius: 18px; padding: 25px; min-height: 250px; border: 1px solid #D1D1D6; font-size: 19px; line-height: 1.7; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .controls { margin-top: 20px; display: flex; flex-direction: column; gap: 10px; }
        .btn { padding: 20px; border-radius: 14px; border: none; font-size: 20px; font-weight: 700; cursor: pointer; transition: 0.2s; }
        .btn-rec { background: #FF3B30; color: white; }
        .btn-stop { background: #007AFF; color: white; display: none; }
        .status { text-align: center; font-weight: 800; color: #8E8E93; margin-bottom: 15px; letter-spacing: 1px; }
        
        /* HIGHLIGHT STYLES */
        .highlight-filler { background: #FFE6E6; border-bottom: 2px solid #FF3B30; color: #FF3B30; font-weight: 600; border-radius: 4px; padding: 0 2px; }
        .highlight-repeat { background: #E8F2FF; border-bottom: 2px solid #007AFF; color: #007AFF; font-weight: 600; border-radius: 4px; padding: 0 2px; }
        
        .legend { display: flex; gap: 15px; margin-top: 15px; font-size: 13px; font-weight: 700; }
        .dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 5px; }
    </style>
</head>
<body>

    <h1>Grammarian Lab v1.1</h1>
    
    <div id="status" class="status">READY TO LISTEN</div>
    <div id="output" class="transcript-box">The literal transcript with highlights will appear here...</div>

    <div class="legend">
        <span><span class="dot" style="background:#FF3B30"></span>Filler Word</span>
        <span><span class="dot" style="background:#007AFF"></span>Word Repeat</span>
    </div>

    <div class="controls">
        <button id="recBtn" class="btn btn-rec" onclick="startRecording()">Start Speech</button>
        <button id="stopBtn" class="btn btn-stop" onclick="stopRecording()">End Speech & Analyze</button>
    </div>

    <script>
        let mediaRecorder;
        let audioChunks = [];
        const aiKey = localStorage.getItem('prod_sdtm_openai_key') || localStorage.getItem('test_sdtm_openai_key');

        async function startRecording() {
            if (!aiKey) { alert("Please add your OpenAI Key in the main app settings first!"); return; }
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            audioChunks = [];
            mediaRecorder.ondataavailable = (event) => audioChunks.push(event.data);
            mediaRecorder.onstop = sendToWhisper;
            mediaRecorder.start();
            document.getElementById('recBtn').style.display = 'none';
            document.getElementById('stopBtn').style.display = 'block';
            document.getElementById('status').innerText = "â— RECORDING LIVE...";
            document.getElementById('status').style.color = "#FF3B30";
        }

        function stopRecording() {
            mediaRecorder.stop();
            document.getElementById('status').innerText = "AI ANALYSIS IN PROGRESS...";
            document.getElementById('status').style.color = "#007AFF";
        }

        async function sendToWhisper() {
            const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
            const formData = new FormData();
            formData.append("file", audioBlob, "recording.webm");
            formData.append("model", "whisper-1");
            formData.append("prompt", "Capture all umms, ahhs, and repetitions literal speech.");

            try {
                const response = await fetch("https://api.openai.com/v1/audio/transcriptions", {
                    method: "POST",
                    headers: { "Authorization": `Bearer ${aiKey}` },
                    body: formData
                });
                const data = await response.json();
                analyzeTranscript(data.text);
            } catch (e) {
                document.getElementById('output').innerText = "Error: " + e.message;
            }
            
            document.getElementById('recBtn').style.display = 'block';
            document.getElementById('stopBtn').style.display = 'none';
            document.getElementById('status').innerText = "ANALYSIS COMPLETE";
        }

        function analyzeTranscript(rawText) {
            // 1. FILLER WORDS
            const fillers = ["UM", "AH", "ER", "UH", "LIKE", "SO", "YOU KNOW", "I MEAN", "BASICALLY", "ACTUALLY"];
            let processed = rawText;

            fillers.forEach(f => {
                const regex = new RegExp(`\\b${f}\\b`, 'gi');
                processed = processed.replace(regex, `<span class="highlight-filler">$&</span>`);
            });

            // 2. DETECT REPEATS (e.g., "The the", "I I")
            // This regex finds a word, then whitespace, then the same word again
            const repeatRegex = /\b(\w+)\s+\1\b/gi;
            processed = processed.replace(repeatRegex, `<span class="highlight-repeat">$&</span>`);

            document.getElementById('output').innerHTML = processed;
        }
    </script>
</body>
</html>
